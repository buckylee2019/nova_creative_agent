# Deploy DPA Agent to AWS AgentCore Runtime

This guide walks you through deploying the Dynamic Product Advertising (DPA) Agent to AWS AgentCore Runtime.

## Prerequisites

1. **AWS Account** with credentials configured
2. **Python 3.10+** installed
3. **AWS Permissions** for AgentCore Runtime deployment
4. **Model Access** - Anthropic Claude Sonnet 4.0 enabled in Amazon Bedrock
5. **S3 Bucket** for Nova Reel video outputs (optional)

## Step 1: Install Required Tools

```bash
# Upgrade pip
pip install --upgrade pip

# Install AgentCore toolkit and dependencies
pip install bedrock-agentcore-starter-toolkit
pip install -r agentcore_requirements.txt
```

## Step 2: Prepare Project Structure

Your project should have this structure:
```
dpa-agent/
â”œâ”€â”€ agentcore_dpa_agent.py    # Main agent code (AgentCore compatible)
â”œâ”€â”€ dpa_mcp_server.py         # MCP server with Nova tools
â”œâ”€â”€ agentcore_requirements.txt # Dependencies for deployment
â”œâ”€â”€ __init__.py               # Makes directory a Python package
â””â”€â”€ bedrock_agentcore.yaml    # Generated by agentcore configure
```

Create the `__init__.py` file:
```bash
touch __init__.py
```

## Step 3: Configure AWS Credentials

Ensure your AWS credentials are configured:
```bash
aws configure
# OR set environment variables:
export AWS_ACCESS_KEY_ID=your_access_key
export AWS_SECRET_ACCESS_KEY=your_secret_key
export AWS_DEFAULT_REGION=us-west-2
```

## Step 4: Enable Model Access

1. Go to Amazon Bedrock console
2. Navigate to "Model access" in the left sidebar
3. Enable access to:
   - Anthropic Claude Sonnet 4.0 (`us.anthropic.claude-sonnet-4-20250514-v1:0`)
   - Amazon Nova Canvas
   - Amazon Nova Reel
   - Amazon Nova Pro

## Step 5: Configure Agent for Deployment

Run the configuration command:
```bash
agentcore configure -e agentcore_dpa_agent.py
```

This will prompt you for:
- **Execution role**: Press Enter to auto-create
- **ECR repository**: Press Enter to auto-create  
- **Dependency file**: Should auto-detect `agentcore_requirements.txt`
- **OAuth**: Type `no` for now (can be configured later)

## Step 6: Deploy to AgentCore Runtime

Deploy your agent:
```bash
agentcore launch
```

This will:
1. Build a Docker container with your agent
2. Push it to Amazon ECR
3. Create an AgentCore Runtime
4. Deploy your agent to AWS

**Note the Agent ARN** from the output - you'll need it to invoke the agent.

## Step 7: Test Your Deployed Agent

Test with the CLI:
```bash
agentcore invoke '{"prompt": "Generate a professional product image of a luxury watch on marble surface"}'
```

## Step 8: Invoke via AWS SDK

Create a test script `test_deployed_agent.py`:

```python
import json
import uuid
import boto3

# Replace with your actual agent ARN
agent_arn = "arn:aws:bedrock-agentcore:us-west-2:123456789012:runtime/dpa-agent-xyz123"

# Initialize the AgentCore client
client = boto3.client('bedrock-agentcore', region_name='us-west-2')

# Test payload
payload = {
    "prompt": "Create a professional advertising image for a coffee mug in a cozy kitchen setting"
}

try:
    # Invoke the agent
    response = client.invoke_agent_runtime(
        agentRuntimeArn=agent_arn,
        sessionId=str(uuid.uuid4()),
        inputText=json.dumps(payload)
    )
    
    # Process the streaming response
    for event in response['completion']:
        if 'chunk' in event:
            chunk = event['chunk']
            if 'bytes' in chunk:
                print(chunk['bytes'].decode('utf-8'), end='')
                
except Exception as e:
    print(f"Error: {e}")
```

## Environment Variables

### Local Development
Create a `.env` file for local testing:

```bash
# Required for cloud deployment
DPA_S3_BUCKET=your-bucket-name-here
CLOUDFRONT_ENDPOINT=d11yb00wkbh4np.cloudfront.net

# Optional configuration
AWS_DEFAULT_REGION=us-east-1
LOG_LEVEL=INFO
MCP_SERVER_PATH=./dpa_mcp_server.py
```

### AgentCore Deployment
**Important:** `.env` files are NOT deployed to AgentCore. Environment variables must be configured in the deployment configuration.

**Automatic Configuration (Recommended):**
```bash
# Use the automated deployment script
python deploy_script.py
```

**Manual Configuration:**
```bash
# Update AgentCore config with environment variables
python update_agentcore_config.py

# View current configuration
python update_agentcore_config.py show
```

**Supported Environment Variables:**
- `DPA_S3_BUCKET` - S3 bucket for storing generated images (required for production)
- `CLOUDFRONT_ENDPOINT` - CloudFront distribution endpoint for faster image delivery
- `AWS_DEFAULT_REGION` - AWS region for services
- `LOG_LEVEL` - Logging level (DEBUG, INFO, WARNING, ERROR)
- `MCP_SERVER_PATH` - Path to MCP server file
- Any variables starting with `DPA_`

**Configuration Format (.bedrock_agentcore.yaml):**
```yaml
bedrock_agentcore:
  environment_variables:
    DPA_S3_BUCKET: "your-bucket-name"
    CLOUDFRONT_ENDPOINT: "d11yb00wkbh4np.cloudfront.net"
    AWS_DEFAULT_REGION: "us-east-1"
    LOG_LEVEL: "INFO"
    MCP_SERVER_PATH: "./dpa_mcp_server.py"
```

## Monitoring and Observability

1. **CloudWatch Logs**: Check the logs location provided during deployment
2. **AgentCore Observability**: Enable in the AWS console for detailed tracing
3. **Health Check**: The agent includes a `/health` endpoint

## Troubleshooting

### Common Issues:

1. **Model Access Denied**
   - Ensure you have enabled model access in Bedrock console
   - Check your IAM permissions for Bedrock

2. **MCP Server Not Found**
   - Ensure `dpa_mcp_server.py` is in the same directory
   - Check the `MCP_SERVER_PATH` environment variable

3. **Deployment Fails**
   - Check AWS credentials and permissions
   - Verify the execution role has necessary permissions
   - Check CloudWatch logs for detailed error messages

4. **Agent Timeout**
   - Increase timeout in the AgentCore configuration
   - Optimize your MCP server startup time

### Useful Commands:

```bash
# Check deployment status
agentcore status

# View logs
agentcore logs

# Update deployment
agentcore launch --update

# Clean up resources
agentcore destroy
```

## Next Steps

1. **Add Authentication**: Configure OAuth for secure access
2. **Custom Domains**: Set up custom domain names for your agent
3. **Monitoring**: Set up CloudWatch alarms and dashboards
4. **Scaling**: Configure auto-scaling based on usage
5. **CI/CD**: Set up automated deployment pipelines

## API Integration

Once deployed, you can integrate the agent into applications:

```python
# Example FastAPI integration
from fastapi import FastAPI
import boto3
import json

app = FastAPI()
agentcore_client = boto3.client('bedrock-agentcore')

@app.post("/generate-ad")
async def generate_ad(request: dict):
    response = agentcore_client.invoke_agent_runtime(
        agentRuntimeArn="your-agent-arn",
        sessionId=str(uuid.uuid4()),
        inputText=json.dumps(request)
    )
    # Process streaming response...
    return {"result": "Generated content"}
```

Your DPA Agent is now running on AWS AgentCore Runtime and ready for production use! ðŸš€